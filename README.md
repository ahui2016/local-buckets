# local-buckets

本地文件倉庫 (管理文件, 備份文件)

- 完全彻底只考虑自用
- 一个工程可以包含一个或多个仓库
- 每个仓库内的文件数量上限是 1024 个（可随时修改）
- 仓库内不可包含子仓库 (子文件夹)
- 每个仓库可单独设置文件大小上下限, 是否加密等参数

## 初始化一个工程 (initialize a project)

1. 新建一个空文件夹
2. 复制 local-buckets.exe 和 public 文件夹, 黏贴到该文件夹中

此时, 该文件夹就是一个新的工程, 启动该文件夹内的 local-buckets.exe, 即可使用这个新工程.

每个工程都有自己的 local-buckets.exe 和 public 文件夹, 这种方式的优点是可以保持每个工程的独立性, 避免工程互相干扰, 缺点是更新升级也需要各个工程分别操作. 由于预估更新升级很少, 工程数量也很少, 因此这个缺点可以容忍.

## 新建仓库

- 通过网页表单新建仓库
- 新建仓库后, 提示用户仓库文件夹的地址, 可点击复制, 同时显示默认设置 (文件体积上限, 是否加密等)
- 仓库文件夹名只能使用 0-9, a-z, A-Z, _(下劃線), -(連字號), .(點)
- 仓库可以有标题, 可使用任何语言任何字符

## 上传文件

- 把想要添加到数据库中的新文件放进 waiting 文件夹
- 在网页界面刷新 waiting.html 页面, 根据页面提示执行添加文件的操作
- 在数据库中, 文件名不分大小写
- 在一个工程内, 文件名必须是唯一的 (即, 不允许有两个同名文件, 不同仓库内的文件也不允许同名)
- 在一个工程内, 文件内容必须是唯一的 (即, 不允许有重复文件)

### 关于文件名的唯一性

- 本来我打算设计为一个仓库内的文件不可同名
  - 举个例子, bucketABC 内不允许有两个 file123.txt,
    但允许 bucketABC 内有一个 file123.txt, 同时 bucketCDE 内也有一个 file123.txt
- 但是为了方便修改文件, 如果一个文件名对应多个仓库, 处理起来就比较复杂,
  因此为了偷懒, 就设计为整个工程内都不允许同名, 也就是说,
  - 如果 bucketABC 内有一个 file123.txt, 那么在 bucketCDE 内也不允许有 file123.txt

不允许跨仓库文件重名的好处:

- **好处1**: 上传文件时发现同名文件, 可以提示用户改文件名或覆盖文件,
  此时如果选择覆盖文件, 就能直接覆盖, 不需要选择仓库.
- **好处2**: 跨仓库移动文件时, 不用处理文件重名的问题.

### waiting

- 网页 waiting 页面只列出等待上传的文件信息, 不提供修改信息的功能
- 网页 waiting 页面可以选择上传到哪个仓库 (Bucket),
  但全部等待文件只能统一选择一个仓库,
  如果想上传到不同仓库, 需要手动分批上传 (分批放进 waiting 文件夹).
- 用户如果想修改文件信息 (备注, 关键词等), 只能在上传后再修改

在技术上, 上传文件时, 前端不会把文件列表传给后端, 只会把 Bucket ID 传给后端,
实际上上传哪些文件, 完全取决于 waiting 文件夹里有什么文件.

### 更新同名文件

- 发现 waiting 文件夹内有文件与数据库中的现有文件同名时, 提示用户处理.
- 用户可选择覆盖或更改文件名.
- 更新同名文件时, 不批量处理, 而是逐一处理.

## 下载文件

- 请勿直接修改文件
- 如果要修改文件内容, 必须先下载, 修改后再上传
- 下载文件默认下载到 waiting 文件夹

## 只读保护

仓库(Bucket), 文件(File) 都自动设为只读权限,
建议用户不要直接修改文件, 而是通过网页界面进行操作.

本来我打算设计为让用户能自由访问仓库 (Bucket), 自由修改文件,
但这样一来就不得不经常扫描全部文件, 计算每一个文件的 checksum,
以便发现哪些文件被修改过, 这会消耗大量计算资源, 会消耗硬盘.

因此, 现在设计为禁止用户直接修改.

## 刷新数据库 (取消该设计)

网页界面有一个很重要的按钮 **Update Database**.

该按钮的主要功能是检查真实文件与数据库中的信息是否一致.

例如, 如果添加了新文件, 然后点击 **Update Database**,  
就能发现真实文件与数据库中的信息不一致, 因为此时数据库中还没有新文件的信息.

另外, 有时我们可能更改文件名, 修改文件内容, 删除文件等等,  
如果不是通过网页界面操作, 而是直接修改真实文件, 就会造成文件与数据库信息不一致.  
此时就需要点击 **Update Database** 按钮刷新数据库.

发现信息不一致后, 提示用户进行下一步处理.

## 删除文件

- 通过网页按钮删除文件 (请勿通过其他途径删除文件)
- 第一次删除只是把文件标记为 "deleted"
- 第二次删除才是真正删除
- 也可以进入文件夹内手动删除文件, 详见下面的 "批量删除" 章节

## 更改文件名

- 在数据库中, 文件名不分大小写
- 通过网页表单更改文件名  (请勿通过其他途径更改文件名)

### 跨仓库移动文件

- 在同一工程内, 可跨仓库移动文件.
- 通过网页表单移动文件  (请勿通过其他途径移动文件)

## 对比, 同步

- 选择框, 动作, 方向, 文件名
- 新增文件 (左→右)
- 新增文件 (右→左)
- 删除文件 (左)
- 删除文件 (右)
- 更新文件 (根据日期初步确定方向, 可点击改变方向)

### 对比同步方案

- 选择右边 (对比目标)
- 选择对比哪些仓库

## 加密

- <https://cryptography.io/en/latest/hazmat/primitives/aead/>
- 每个仓库可单独选择是否加密
- 每个工程统一一个密码, 换言之, 一个工程内的各个加密仓库的密码相同
- 未输入密码不会显示加密仓库
- 初始密码是 "abc123", 请自行更改密码.

## 备份密钥

- 必须备份 project.toml 文件, 否则即使输入正确密码也无法解密.  
- 更具体而言, 必须拥有正确密码以及 project.toml 里的 CipherKey 才能解密.
- 并且要注意, 更改密码会改变 CipherKey, 因此每次更改密码后都要重新备份 CipherKey.
- 建议使用密码管理器记住密码和 CipherKey.

### 加密强度

密码越短越容易被破解, 本软件的加密方式, 要求密码长度超过 15 位才比较安全.

但是, 本软件的加密目的只是为了稍稍提高保密性而已, 不建议用来保存特别重要的机密.

因此, 反而建议密码短一点, 比如 8 位大小写英文字母与数字的组合, 万一忘记密码, 自己破解起来也比较容易, 没必要追求太高的加密强度.

总之, 根据自己的保密性需求来决定密码长度吧.
